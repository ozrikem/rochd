<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/app-layout/app-grid/app-grid-style.html">
<link rel="import" href="lorem-with-title.html">

<dom-module id="rochd-app">
  <template>
    <style include="app-grid-style">
      :host {
        display: block;
        --app-grid-columns: 1;
      }
      .main-paper-tabs {
        /* Canceling default margin */
        margin-left: -8px;
        margin-top: -8px;
        
        background-color: #13171E;
        --paper-tabs-selection-bar-color: red;
      }
      .secondary-paper-tabs {
        background-color: black;
        margin-left: 280px;
        padding-right: 150px;
      }
      paper-tab {
        color: white;
      }
      img.menu-icon {
        width: 50px;
        height: 50px;
      }
      #submenusroutes {
        padding-top: 100px;
      }
      #header-menus {
        width: 100%;
        position: fixed;
      }
    </style>
    
    <app-location route="{{route}}" use-hash-as-path></app-location>
    <app-route
      route="{{route}}"
      pattern="/:page"
      data="{{routeData}}"
      tail="{{routeTail}}">
    </app-route>
    
    <div id="header-menus">
      <!-- Main menu -->
      <paper-tabs class="main-paper-tabs" selected="{{selectedMain}}">
        <paper-tab disabled>
          <img src="../../images/logo.png" class="menu-icon"></img>
        </paper-tab>
        <paper-tab>Accueil</paper-tab>
        <paper-tab>Exception</paper-tab>
        <paper-tab>Concept</paper-tab>
        <paper-tab>Projection</paper-tab>
        <paper-tab>Gamification</paper-tab>
        <paper-tab>Open Source</paper-tab>
        <paper-tab>Pol XXIe s</paper-tab>
        <paper-tab disabled>
          <img src="../../images/user.png" class="menu-icon"></img>
        </paper-tab>
      </paper-tabs>
      
      <!-- Routing to submenus -->
      <iron-pages selected="[[_decrement(selectedMain)]]">
        <paper-tabs class="secondary-paper-tabs" selected="{{selectedSecond}}"
          no-bar>
          <paper-tab>BonneP</paper-tab>
          <paper-tab>Trouver</paper-tab>
          <paper-tab>Media</paper-tab>
          <paper-tab>A propos</paper-tab>
        </paper-tabs>
        <paper-tabs class="secondary-paper-tabs" selected="{{selectedSecond}}"
          no-bar>
          <paper-tab>Introduction text</paper-tab>
          <paper-tab>TimelineJS</paper-tab>
          <paper-tab>Tableaux et schémas</paper-tab>
          <paper-tab>Tribunes</paper-tab>
        </paper-tabs>
        <div></div>
        <paper-tabs class="secondary-paper-tabs" selected="{{selectedSecond}}"
          no-bar>
          <paper-tab>Com WT</paper-tab>
          <paper-tab>Atlantic</paper-tab>
          <paper-tab>IAS</paper-tab>
        </paper-tabs>
        <paper-tabs class="secondary-paper-tabs" selected="{{selectedSecond}}"
          no-bar>
          <paper-tab>Doctrine</paper-tab>
          <paper-tab>Concept</paper-tab>
        </paper-tabs>
        <paper-tabs class="secondary-paper-tabs" selected="{{selectedSecond}}"
          no-bar>
          <paper-tab>Initiatives MA</paper-tab>
          <paper-tab>Bibliographie</paper-tab>
          <paper-tab>Trouver des sources</paper-tab>
        </paper-tabs>
        <paper-tabs class="secondary-paper-tabs" selected="{{selectedSecond}}"
          no-bar>
          <paper-tab>M chat Net</paper-tab>
          <paper-tab>Data Pol</paper-tab>
          <paper-tab>Pirate</paper-tab>
        </paper-tabs>
      </iron-pages>
    </div>
    
    <!-- Routing to page content -->
    <iron-pages id="submenusroutes" selected="[[_decrement(selectedMain)]]">
      <div class="app-grid">
        <lorem-with-title id="bonnep" title="BonneP"></lorem-with-title>
        <lorem-with-title id="find" title="Trouver"></lorem-with-title>
        <lorem-with-title id="media" title="Media"></lorem-with-title>
        <lorem-with-title id="about" title="A propos"></lorem-with-title>
      </div>
      <div class="app-grid">
        <lorem-with-title id="intro" title="Introduction text"></lorem-with-title>
        <lorem-with-title id="timelinejs" title="TimelineJS"></lorem-with-title>
        <lorem-with-title id="tableschemes" title="Tableaux et schémas"></lorem-with-title>
        <lorem-with-title id="tribunes" title="Tribunes"></lorem-with-title>
      </div>
      <div class="app-grid">
        <lorem-with-title id="concepts" title="Concepts"></lorem-with-title>
      </div>
      <div class="app-grid">
        <lorem-with-title id="comwt" title="Com WT"></lorem-with-title>
        <lorem-with-title id="atlantic" title="Atlantic"></lorem-with-title>
        <lorem-with-title id="ias" title="IAS"></lorem-with-title>
      </div>
      <div class="app-grid">
        <lorem-with-title id="doctrine" title="Doctrine"></lorem-with-title>
        <lorem-with-title id="concept" title="Concept"></lorem-with-title>
      </div>
      <div class="app-grid">
        <lorem-with-title id="initiativesma" title="Initiatives MA"></lorem-with-title>
        <lorem-with-title id="bibliography" title="Bibliographie"></lorem-with-title>
        <lorem-with-title id="findsources" title="Trouver des sources"></lorem-with-title>
      </div>
      <div class="app-grid">
        <lorem-with-title id="mchatnet" title="M chat Net"></lorem-with-title>
        <lorem-with-title id="datapol" title="Data Pol"></lorem-with-title>
        <lorem-with-title id="pirate" title="Pirate"></lorem-with-title>
      </div>
    </iron-pages>
    
  </template>

  <script>
    Polymer({
      is: "rochd-app",
      properties: {
        
        // Page names in URLs corresponding to the different tabs in the main menu
        pages: {
          type: Array,
          value: [
            "accueil",
            "exception",
            "concept",
            "projection",
            "gamification",
            "opensource",
            "polxxies"
          ],
          readOnly: true
        },
        
        // Each row of the following table contains the list of items in the submenu,
        // for each menu
        subMenusMap: Array,
        
        // Index of the selected item in the main menu
        // Warning: starts at 1
        selectedMain: {
          type: Number,
          value: 1,
          observer: "_changePageInURL"
        },
        
        // Index of the selected item in the secondary menu
        selectedSecond: {
          type: Number,
          value: 0,
          observer: "_changeSectionInURLAndScroll"
        }
      },
      
      // Observers when the page or the section changes in the URL
      observers: [
        '_routeDataChanged(routeData.page)',
        '_routeTailChanged(routeTail.path)'
      ],
      
      // Useful to decrement this.selectedMain in the one-way binding pattern
      // (since this.selectedMain starts at 1)
      _decrement: function(n) {
        return n-1;
      },
      
      // Fired when the page changes in the URL
      _routeDataChanged: function() {
        if (this.subMenusMap && this.routeData && this.routeData.page) {
          this.selectedMain = this.pages.indexOf(this.routeData.page) + 1;
        }
      },
      
      // Fired when the tail changes in the URL
      _routeTailChanged: function() {
        if (this.subMenusMap &&this.routeTail && this.routeTail.path &&
          this.routeTail.path.length > 1) {
          this.selectedSecond = this.subMenusMap[this.selectedMain-1].indexOf(
            this.routeTail.path.substring(1));
            
          // Scrolling to the section  
          var sectionName = this.routeTail.path.substring(1);
          var sectionIdx = this.subMenusMap[this.selectedMain-1].indexOf(sectionName);
          if (sectionIdx > -1) {
            this.selectedSecond = sectionIdx;              
            var offset = (this.subMenusMap[this.selectedMain-1].length > 1) ? -100 : -50;
            var scrollPos = document.querySelector("#" + sectionName).offsetTop +
              offset;
            setTimeout(function() {
              window.scroll(0, scrollPos);
            }, 100);
          }
        }
      },
      
      // Fired when this.selectedMain changes
      _changePageInURL: function() {
        if (this.subMenusMap && this.selectedMain >= 0) {
          if (this.selectedSecond < 0) {
            this.selectedSecond = 0;
          }
        }
      },
      
      // Fired when this.selectedSecond changes
      _changeSectionInURLAndScroll: function() {
        if (this.subMenusMap && this.selectedSecond >= 0) {
          window.location.hash = "/" + this.pages[this.selectedMain-1] + "/" +
            this.subMenusMap[this.selectedMain-1][this.selectedSecond];
        }
      },
      
      // Fired when the component is attached to the document
      attached: function() {
        // Sub-menus map initialization
        var subMenusRoutes = document.querySelector("#submenusroutes");
        this.subMenusMap = [];
        for (var routeIdx = 0; routeIdx < subMenusRoutes.childElementCount; routeIdx++) {
          var route = subMenusRoutes.children[routeIdx];
          var items = [];
          for (var componentIdx = 0; componentIdx < route.childElementCount;
            componentIdx++) {
            items.push(route.children[componentIdx].id);
          }
          
          this.subMenusMap.push(items);
        }
        
        // Handling initial URL
        //
        // Incomplete: no page and no section
        if (this.route.path === "" || this.route.path === "/" ||
          this.routeData.page === "" || this.routeData.page === "/") {
          window.location.hash = "/" + this.pages[0] + "/" + this.subMenusMap[0][0];
          
        // Incomplete: page provided but no section
        } else if (this.routeTail && this.routeTail.path &&
          (this.routeTail.path === "" || this.routeTail.path === "/")) {
          var page = (this.routeData.page.substring(0,1) === "/") ?
            this.routeData.page.substring(1) : this.routeData.page;
          var pageIdx = this.pages.indexOf(page);
          if (pageIdx < 0) {
            // if the section is not recognized, go to the first one
            window.location.hash = "/" + this.pages[0] + "/" + this.subMenusMap[0][0];
          } else {
            window.location.hash = "/" + page + "/" + this.subMenusMap[pageIdx][0];
          }
          
        // Complete: page and section provided, scrolling directly
        } else {
          this.selectedMain = -1;
          this.selectedSecond = -1;
          this._routeDataChanged();
          this._routeTailChanged();
        }
        
        // When clicking on the menu, this.selectedSecond has to be reinitialized to 0
        // (here put to -1 then put to 0 in _changePageInURL, so that the observer is
        // fired only once).
        // This is useful to distiguish between the cases when the page changes because
        // of an actual user click on the menu or after hitting the back button
        document.querySelector(".main-paper-tabs").addEventListener(
          "iron-activate", function() {
            var app = document.querySelector("rochd-app");
            app.selectedSecond = -1;
          }
        );
      },
    });
  </script>
</dom-module>
